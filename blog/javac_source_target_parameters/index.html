<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Beware of the -source and -target javac parameters&nbsp;|&nbsp;saker.build blog</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
	
	<link rel="stylesheet" href="../../res/bootstrap.min.css" >
	<link rel="stylesheet" href="../../res/doc-saker.css" >
	
</head>
<body data-nav-location="blog">
<div class="doc-nav-bar">
	<div class="container">
		<a class="home-link" href="/index.html" title="saker.build"><img style="height: 2.5em;" class="logo" src="/res/logo.svg"/><span class="page-name">saker.build</span></a>
		<div class="nav-bar-controls">
			<a class="nav-bar-special" href="/saker.build/doc/installation.html" title="saker.build installation">Download</a>
			<label class="d-lg-none nav-bar-collapse" for="collapse-nav-bar-label">
				<svg style="height: 1.5em;" viewBox="0 0 24 24">
				    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
				</svg>
			</label>
			<input style="display:none;" id="collapse-nav-bar-label" type="checkbox"/>
			<div class="nav-bar-items">
				<a href="/saker.build/doc/index.html" title="saker.build documentation">Documentation</a>
				<a href="/buildtrace.html" title="Build trace viewer">Build trace</a>
				<a style="display:none;" href="/sponsor.html" title="Sponsoring development">Sponsor</a>
				<a href="/blog/" title="saker.build system blog">Blog</a>
				<a class="no-external-icon" href="https://github.com/sakerbuild/saker.build" title="saker.build GitHub repository">GitHub</a>
			</div>
		</div>
	</div>
</div>
<div class="container page-contents packagedoc">
	<div class="row">
		<div class="col-12 col-lg-3 col-xl-2 p-lg-0">
			<div class="doc-navigation-container">
				<label class="d-lg-none nav-collapse" for="doc-collapse-nav-label">
					<svg style="height: 1.5em;" viewBox="0 0 24 24">
					    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
					</svg>
					Navigation
				</label>
				<input style="display:none;" id="doc-collapse-nav-label" type="checkbox"/> 
				<div class="doc-nav">  <div class="doc-section"><ul><li><a class="doc-nav-section-link" href="../index.html" title="Welcome">Welcome</a></li><li><a class="doc-nav-section-link" href="../archive.html" title="Blog archive">Blog archive</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Releases</p><ul><li><a class="doc-nav-section-link" href="../release_0.8.0.html" title="Release 0.8.0 (initial)">Release 0.8.0 (initial)</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Blog posts</p><ul><li class="doc-active doc-active-parent"><a class="doc-nav-section-link" href="index.html" title="Beware of the -source and -target javac parameters">Beware of the -source and -target javac parameters</a></li><li><a class="doc-nav-section-link" href="../intro_build_trace/index.html" title="Introducing the build trace for saker.build">Introducing the build trace for saker.build</a></li><li><a class="doc-nav-section-link" href="../do_i_need_a_build_system.html" title=""Do I need a build system?"">"Do I need a build system?"</a></li><li><a class="doc-nav-section-link" href="../github_packages_maven/index.html" title="Using the GitHub packages Maven repository">Using the GitHub packages Maven repository</a></li><li><a class="doc-nav-section-link" href="../odd_initial_release_number.html" title="0.8.0 seems like an odd initial release number">0.8.0 seems like an odd initial release number</a></li><li><a class="doc-nav-section-link" href="../another_buildsystem.html" title="Do we need another build system?">Do we need another build system?</a></li></ul>  </div></div>
			</div>
		</div>
		<div class="col-12 col-lg-9 col-xl-10 doc-page">
			<div class="sb-sponsors" style="display: none;">
	<span class="sb-sponsors-title">Sponsors</span>
	<div class="container">
		<div class="row">
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
		</div>
	</div>
</div>
			<div class="doc-content"><h1 id="beware-of-the--source-and--target-javac-parameters">Beware of the <code>-source</code> and <code>-target</code> javac parameters<a class="doc-heading-anchor" href="#beware-of-the--source-and--target-javac-parameters"></a></h1>
<p><small>2020 February 27</small></p>
<p>If you've been cross-compiling Java code for older releases, and were using the <code>-source</code> and <code>-target</code> javac parameters, you may experience unexpected errors when your app is deployed. Let's see why.</p>
<p>In the following, we'll compile a simple class to Java 8, using javac from JDK 9. The source is as follows:</p>
<pre class="doc-code-block"><code class="language-java">import java.nio.ByteBuffer;

public class Compile8Test {
    public static void main(String[] args) {
        ByteBuffer bb = ByteBuffer.allocate(16);
        bb.flip();
        System.out.println(&quot;Success&quot;);
    }
}
</code></pre>
<p>It's quite simple and should properly work on Java 8, 9, or later.</p>
<h3 id="using---release">Using <code>--release</code><a class="doc-heading-anchor" href="#using---release"></a></h3>
<p>Let's compile it for Java 8, using the <code>--release</code> option.</p>
<pre class="doc-code-block"><code class="language-plaintext">path/to/jdk9/bin/javac Compile8Test.java --release 8
</code></pre>
<p>As a test, we should run it on <strong>Java 8</strong>:</p>
<pre class="doc-code-block"><code class="language-plaintext">path/to/java8/bin/java Compile8Test
</code></pre>
<p>The output is nothing out of the ordinary:</p>
<pre class="doc-code-block"><code class="language-plaintext">Success
</code></pre>
<p>This was the correct example, showcasing how you <em>should</em> cross-compile Java for older versions.</p>
<h3 id="using--source-and--target">Using <code>-source</code> and <code>-target</code><a class="doc-heading-anchor" href="#using--source-and--target"></a></h3>
<p>The <code>--release</code> option was introduced in JDK 9. If you're like us, you may've just upgraded your Java version without putting much thought into how it may affect your compilation process. You (or your underlying build system) may've kept using the <code>-source</code> and <code>-target</code> parameters although the <code>--release</code> was just introduced.</p>
<p>Let's see how it can affect our compilation output:</p>
<pre class="doc-code-block"><code class="language-plaintext">path/to/jdk9/bin/javac Compile8Test.java -source 8 -target 8
</code></pre>
<p>It compiles fine, we do receive a warning though:</p>
<pre class="doc-code-block"><code class="language-plaintext">warning: [options] bootstrap class path not set in conjunction with -source 1.8
</code></pre>
<p>Whatever... Warnings are just warnings. Let's run it!</p>
<pre class="doc-code-block"><code class="language-plaintext">path/to/java8/bin/java Compile8Test
</code></pre>
<p>The output it not what we'd expect:</p>
<pre class="doc-code-block"><code class="language-plaintext">Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: java.nio.ByteBuffer.flip()Ljava/nio/ByteBuffer;
        at Compile8Test.main(Compile8Test.java:6)
</code></pre>
<p>Okay, so what's up? Well the fact is that although we specified the source and target levels to conform to Java 8, the compilation is still done against the classes in JDK 9! Issues don't surface often because of this, as Java is generally developed in a backward compatible way. However, a new method was introduced in <code>ByteBuffer</code> in JDK 9:</p>
<pre class="doc-code-block"><code class="language-java">@Override
public ByteBuffer flip() {
    super.flip();
    return this;
}
</code></pre>
<p>It's basically just for convenience to return a more suitable type of the buffer from the method. As it was introduced in Java 9, running the compiled code on Java 8 will fail, as the code still references the above method, but it's not present in Java 8. (Well, it is present as it is overridden, but it has a different return type, therefore the method lookup based on the descriptor fails.)</p>
<p>We can see this more in detail if we run <code>javap</code>:</p>
<pre class="doc-code-block"><code class="language-plaintext">&gt; path/to/java8/bin/javap -v -c Compile8Test.class
public class Compile8Test
  minor version: 0
  major version: 52
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
[ ... ]
  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=2, args_size=1
         0: bipush        16
         2: invokestatic  #2  // Method java/nio/ByteBuffer.allocate:(I)Ljava/nio/ByteBuffer;
         5: astore_1
         6: aload_1
         7: invokevirtual #3  // Method java/nio/ByteBuffer.flip:()Ljava/nio/ByteBuffer;
        10: pop
        11: getstatic     #4  // Field java/lang/System.out:Ljava/io/PrintStream;
        14: ldc           #5  // String Success
        16: invokevirtual #6  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        19: return
</code></pre>
<p>See the line with <code>7: // Method java/nio/ByteBuffer.flip:()Ljava/nio/ByteBuffer;</code>? That method doesn't exist on Java 8! To put that in contrast with the <code>javap</code> output of the correctly cross-compiled version:</p>
<pre class="doc-code-block"><code class="language-plaintext">  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=2, args_size=1
         0: bipush        16
         2: invokestatic  #2  // Method java/nio/ByteBuffer.allocate:(I)Ljava/nio/ByteBuffer;
         5: astore_1
         6: aload_1
         7: invokevirtual #3  // Method java/nio/ByteBuffer.flip:()Ljava/nio/Buffer;
      [ ... ]
</code></pre>
<p>You can see that the descriptor of the called methods are different.</p>
<h2 id="mitigation">Mitigation<a class="doc-heading-anchor" href="#mitigation"></a></h2>
<p>The straightforward solution for the above problem is to just use the <code>--release</code> parameter. However, if you use JDK 8 to compile, that is not possible. In most cases you don't even interact with <code>javac</code> directly, but use some build system that calls it for you. In any cases, you will need a build system that can properly handle the <code>--release</code> flag if running on JDK 9+, or use the <code>-source</code> and <code>-target</code> parameters for older releases.</p>
<p>Another solution is to use javac that comes with the JDK you're targetting. You may also need to set the <code>-bootclasspath</code> for the compilation if targetting Java 7 or older releases. In all cases however, you need to be careful with your compilation setup when doing cross-compilation.</p>
<p>You may be happy to know that saker.build supports <a href="../../saker.java.compiler/doc/javacompile/crosscompile.html" title="Cross-compilation">cross-compilation</a> in various ways that mitigate this problem.</p>
<h2 id="conclusion">Conclusion<a class="doc-heading-anchor" href="#conclusion"></a></h2>
<p>We've seen that using the <code>-source</code> and <code>-target</code> parameters when cross-compiling Java may cause unexpected issues in your deployment environment. If you may take one advice from us is that you should check your build tools if they perform this correctly. This issue probably doesn't affect you, as these are edge cases, and your integration tests probably discovered them already. In any case, we hope this post was informational to you.</p>
<small>
<p>This post was made because we've discovered an issue with the <code>apksigner</code> tool when developing <a href="https://github.com/sakerbuild/saker.android" title="GitHub - sakerbuild/saker.android: Android support for the saker.build system">Android support</a> for saker.build. It was mistakenly compiled for Java 9 in the 30 rc1 release of the build tools, and as we load the <code>apksigner.jar</code> directly in the build JVM process, it caused errors such as above.</p>
<p>We filed an <a href="https://issuetracker.google.com/issues/150189789" title="APKsigner requires Java 9 in Build tools 30 rc1 [150189789] - Issue Tracker">issue</a> in the respective tracker, and hope it will be resolved soon. In any way, thankfully this doesn't block the development of Android support for saker.build, as this issue can be mitigated easily by instrumenting the loaded classes and replacing the affected method calls.</p>
</small>
<link href="../../css/sakerscript.css"  rel="stylesheet" type="text/css" /></div>
			<div class="doc-headings-nav">  <ul>    <li><a href="#beware-of-the--source-and--target-javac-parameters" title="Beware of the -source and -target javac parameters">Beware of the -source and -target javac parameters</a>      <ul>        <li><a href="#using---release" title="Using --release">Using --release</a>        </li>        <li><a href="#using--source-and--target" title="Using -source and -target">Using -source and -target</a>        </li>        <li><a href="#mitigation" title="Mitigation">Mitigation</a>        </li>        <li><a href="#conclusion" title="Conclusion">Conclusion</a>        </li>      </ul>    </li>  </ul></div>
		</div>
	</div>
</div>
<div class="doc-footer">
	<div class="container">
		<div class="row">
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">About</p>
				<div><a href="/" title="Saker.build home page">Home</a></div>
				<div><a href="/saker.build/doc/roadmap.html" title="Saker.build development roadmap">Roadmap</a></div>
				<div style="display:none;"><a href="/sponsor.html" title="Sponsoring development">Sponsor</a></div>
				<div><a href="/saker.build/doc/contribute.html" title="Contributing to the saker.build system development">Contribute</a></div>
				<div><a href="/contact.html" title="Contact us">Contact</a></div>
			</div>
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">Resources</p>
				<div><a href="/saker.build/doc/index.html" title="saker.build documentation">Documentation</a></div>
				<div><a href="/saker.build/javadoc/index.html" title="Saker.build API JavaDoc">JavaDoc</a></div>
				<div><a href="https://github.com/sakerbuild/saker.build" title="saker.build on GitHub">GitHub</a></div>
			</div>
		</div>	
		<div class="row">
			<div class="col">
			&copy; Bence Sipka 2020
			</div>
		</div>
	</div>
</div>

<link rel="stylesheet" href="../../res/hljs.css"><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js" integrity="sha256-js+I1fdbke/DJrW2qXQlrw7VUEqmdeFeOW37UC0bEiU=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/languages/java.min.js"></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/languages/plaintext.min.js"></script>
<script>
if(window.hasOwnProperty("hljs")){
	hljs.configure({
	  languages: []
	});
	hljs.initHighlightingOnLoad();
}
</script>

</body>
</html>