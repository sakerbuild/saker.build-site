<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Bundle classpath&nbsp;|&nbsp;saker.nest</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
	
	<link rel="stylesheet" href="../../../res/bootstrap.min.css" >
	<link rel="stylesheet" href="../../../res/doc-saker.css" >
</head>
<body data-nav-location="packagedoc" data-subdoc-presence="nest-package packagedoc javadoc">
<div class="doc-nav-bar">
	<div class="container">
		<a class="home-link" href="../../index.html" title="saker.nest"><img style="height: 2.5em;" class="logo" src="../../../res/logo.svg"/><span class="page-name">saker.nest</span></a>
		<a class="nav-location-item" data-nav-location="doc-docs" href="../../doc/index.html" title="Documentation">Documentation</a>
		<a class="nav-location-item" data-nav-location="doc-taskdoc" href="../../taskdoc/index.html" title="Build task documentation">TaskDoc</a>
		<a class="nav-location-item" data-nav-location="doc-javadoc" href="../../javadoc/index.html"title="Java API documentation">JavaDoc</a>
		<div class="nav-bar-controls">
			<label class="d-xl-none nav-bar-collapse" for="collapse-nav-bar-label">
				<svg style="height: 1.5em;" viewBox="0 0 24 24">
				    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
				</svg>
			</label>
			<input style="display:none;" id="collapse-nav-bar-label" type="checkbox"/>
			<div class="nav-bar-items">
				<a href="/" title="saker.build home page">Home</a>
				<a href="/buildtrace.html" title="Build trace viewer">Build trace</a>
				<a style="display:none;" href="/sponsor.html" title="Sponsoring development">Sponsor</a>
				<a href="/blog/" title="saker.build system blog">Blog</a>
				<a class="no-external-icon" href="https://github.com/sakerbuild/saker.build" title="saker.build GitHub repository">GitHub</a>
			</div>
		</div>
	</div>
</div>
<div class="container page-contents packagedoc">
	<div class="row">
		<div class="col-12 col-lg-3 col-xl-2 p-lg-0">
			<div class="doc-navigation-container">
				<label class="d-lg-none nav-collapse" for="doc-collapse-nav-label">
					<svg style="height: 1.5em;" viewBox="0 0 24 24">
					    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
					</svg>
					Navigation
				</label>
				<input style="display:none;" id="doc-collapse-nav-label" type="checkbox"/> 
				<div class="doc-nav">  <div class="doc-section"><ul><li><a class="doc-nav-section-link" href="../../index.html" title="Index">Index</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Introduction</p><ul><li><a class="doc-nav-section-link" href="../index.html" title="Overview">Overview</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_0"><a class="doc-nav-section-link" href="../installation.html" title="Installation">Installation</a></label><input style="display:none;" id="_doc_collapse_id_0" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_0"></label><ul><li><a class="doc-nav-section-link" href="../releasearchive.html" title="Release archive">Release archive</a></li></ul></li><li><a class="doc-nav-section-link" href="../roadmap.html" title="Roadmap">Roadmap</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">User guide</p><ul><li><a class="doc-nav-section-link" href="../userguide/index.html" title="Repository structure">Repository structure</a></li><li><a class="doc-nav-section-link" href="../userguide/buildtasks.html" title="Build tasks">Build tasks</a></li><li><a class="doc-nav-section-link" href="../userguide/versioning.html" title="Versioning">Versioning</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_1"><a class="doc-nav-section-link" href="../userguide/configuration.html" title="Runtime configuration">Runtime configuration</a></label><input style="display:none;" id="_doc_collapse_id_1" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_1"></label><ul><li><a class="doc-nav-section-link" href="../userguide/serverstorage.html" title="Server storage">Server storage</a></li><li><a class="doc-nav-section-link" href="../userguide/localstorage.html" title="Local storage">Local storage</a></li><li><a class="doc-nav-section-link" href="../userguide/paramsstorage.html" title="Parameter storage">Parameter storage</a></li><li><a class="doc-nav-section-link" href="../userguide/constraints.html" title="Constraint properties">Constraint properties</a></li></ul></li><li><a class="doc-nav-section-link" href="../userguide/localbundles.html" title="Local bundles">Local bundles</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_2"><a class="doc-nav-section-link" href="../userguide/cmdlineref/index.html" title="Command line reference">Command line reference</a></label><input style="display:none;" id="_doc_collapse_id_2" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_2"></label><ul><li><a class="doc-nav-section-link" href="../userguide/cmdlineref/main.html" title="main">main</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_3"><a class="doc-nav-section-link" href="../userguide/cmdlineref/local.html" title="local">local</a></label><input style="display:none;" id="_doc_collapse_id_3" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_3"></label><ul><li><a class="doc-nav-section-link" href="../userguide/cmdlineref/local_install.html" title="install">install</a></li></ul></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_4"><a class="doc-nav-section-link" href="../userguide/cmdlineref/server.html" title="server">server</a></label><input style="display:none;" id="_doc_collapse_id_4" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_4"></label><ul><li><a class="doc-nav-section-link" href="../userguide/cmdlineref/server_upload.html" title="upload">upload</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_5"><a class="doc-nav-section-link" href="../userguide/cmdlineref/server_index.html" title="index">index</a></label><input style="display:none;" id="_doc_collapse_id_5" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_5"></label><ul><li><a class="doc-nav-section-link" href="../userguide/cmdlineref/server_index_update.html" title="update">update</a></li></ul></li></ul></li><li><a class="doc-nav-section-link" href="../userguide/cmdlineref/version.html" title="version">version</a></li></ul></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Repository website</p><ul><li><a class="doc-nav-section-link" href="../websiteguide/index.html" title="Overview">Overview</a></li><li><a class="doc-nav-section-link" href="../websiteguide/naming.html" title="Naming">Naming</a></li><li><a class="doc-nav-section-link" href="../websiteguide/uploading.html" title="Uploading bundles">Uploading bundles</a></li><li><a class="doc-nav-section-link" href="../websiteguide/publishing.html" title="Publishing">Publishing</a></li><li><a class="doc-nav-section-link" href="../websiteguide/descriptions.html" title="Descriptions">Descriptions</a></li><li><a class="doc-nav-section-link" href="../websiteguide/faq.html" title="FAQ">FAQ</a></li><li><a class="doc-nav-section-link" href="../websiteguide/repository_api.html" title="Repository web API">Repository web API</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Development guide</p><ul><li><a class="doc-nav-section-link" href="index.html" title="Overview">Overview</a></li><li><a class="doc-nav-section-link" href="bundleformat.html" title="Bundle format">Bundle format</a></li><li><a class="doc-nav-section-link" href="dependencies.html" title="Dependencies">Dependencies</a></li><li class="doc-active doc-active-parent"><a class="doc-nav-section-link" href="classpath.html" title="Bundle classpath">Bundle classpath</a></li><li><a class="doc-nav-section-link" href="dependencyhell.html" title="Dependency hell">Dependency hell</a></li><li><a class="doc-nav-section-link" href="tasks.html" title="Build tasks">Build tasks</a></li><li><a class="doc-nav-section-link" href="runtimeaccess.html" title="Accessing the repository runtime">Accessing the repository runtime</a></li><li><a class="doc-nav-section-link" href="testing.html" title="Integration testing">Integration testing</a></li></ul>  </div></div>
			</div>
		</div>
		<div class="col-12 col-lg-9 col-xl-10 doc-page">
			<div class="doc-breadcrumb">
				Development guide &gt; <a href="classpath.html" title="Bundle classpath">Bundle classpath</a>
			</div>
			<div class="sb-sponsors" style="display: none;">
	<span class="sb-sponsors-title">Sponsors</span>
	<div class="container">
		<div class="row">
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
		</div>
	</div>
</div>
			<div class="doc-content"><h1 id="bundle-classpath">Bundle classpath<a class="doc-heading-anchor" href="#bundle-classpath"></a></h1>
<p>This document describes how the classpath loading of the bundles work.</p>
<p>As the first step of loading classes from a bundle, the repository runtime will check if it is suitable for the <a href="../userguide/constraints.html" title="Constraint properties">current environment</a> to run on. It will examine the <code>Nest-ClassPath-Supported-*</code> attributes of the <a href="bundleformat.html#manifest-file" title="Manifest file">bundle manifest</a>, and check if it allows the bundle to be loaded in the current environment. If it is not suitable, an appropriate exception is thrown by the runtime.</p>
<p>As the second step, the runtime will resolve the declared dependencies of the bundle. The dependencies are resolved fro the <code>classpath</code> kind. Any dependency that is declared with this kind will be used to resolve the dependencies of bundles in a transitive way. During resolution, the meta-data specifications mentioned in <a href="dependencies.html#dependency-meta-data" title="Dependency meta-data">Dependency meta-data</a> will be taken into account. For every dependent bundle, the current environment suitability will also be checked.</p>
<p>As a last step, the <code>Nest-ClassPath-Special</code> manifest attribute of the bundle is taken into account to create the <a href="../../javadoc/saker/nest/bundle/NestBundleClassLoader.html"><code>ClassLoader</code></a> for the bundle. If necessary, the JDK tool classes will be made accessible for the bundle classes.</p>
<p>Some important aspects of the class loading is discussed below.</p>
<h2 id="bundle-lifecycle">Bundle lifecycle<a class="doc-heading-anchor" href="#bundle-lifecycle"></a></h2>
<p>Contrary to other package management solutions, there's <strong>no bundle lifecycle</strong> defined for saker.nest packages. Your Java classes are not notified when the bundle is first loaded, or when it is unloaded. <em>Bundles shouldn't hold references to managed resources.</em></p>
<p>A bundle should be used as a container of resources, not some service provider.</p>
<h2 id="multiple-classloaders">Multiple ClassLoaders<a class="doc-heading-anchor" href="#multiple-classloaders"></a></h2>
<p>Important to note that a single bundle can be loaded <strong>multiple times</strong> by the repository runtime. This is due to having different bundle dependency resolutions in some cases. Let's look at the following example:</p>
<pre class="doc-code-block"><code class="language-plaintext">first.bundle-v1         second.bundle-v1
|            |           |            |
| 1.0        | 1.0       | 1.0        |
|            |           |            |
|            V           V            |
|         dependent.bundle-v1.0       | 2.0
|            |           |            |
|            | [1, 3]    | [1, 3]     |
|            |           |            |
V            V           V            V
common.bundle-v1.0      common.bundle-v2.0
</code></pre>
<p>The bundles define the dependencies for the given bundles with the specified <a href="../userguide/versioning.html#version-ranges" title="Version ranges">version ranges</a>. If we resolve the dependencies for <code>siple.bundle-v1</code>, we will have the following result:</p>
<pre class="doc-code-block"><code class="language-plaintext">first.bundle-v1
dependent.bundle-v1.0
common.bundle-v1.0
</code></pre>
<p>However, if we resolve the dependencies for <code>second.bundle-v1</code>, we will have the following:</p>
<pre class="doc-code-block"><code class="language-plaintext">second.bundle-v1
dependent.bundle-v1.0
common.bundle-v2.0
</code></pre>
<p>Let us look at the class accessibility of <code>dependent.bundle-v1.0</code>. In the first case, the dependent bundle has access to the <code>common.bundle-v1.0</code> classes. However, in the second case, the <code>common.bundle-v2.0</code> was resolved, because <code>second.bundle-v1</code> pinned that specific version.</p>
<p>In this case, two <em>completely different</em> ClassLoader is instantiated for <code>dependent.bundle-v1.0</code>. This results in that classes from the dependent bundle being loaded into the runtime <strong>multiple times</strong>. This is the scenario commonly known as dependency hell or <a href="https://en.wikipedia.org/wiki/Java_Classloader#JAR_hell" title="Java Classloader - Wikipedia">JAR hell</a>.</p>
<p>The saker.nest repository does not attempt to solve this problem on its own, but rather provides development guidelines that help mitigating this issue. It requires employing specific development practices by the package authors to avoid dealing with this issue.</p>
<p>See <a href="dependencyhell.html" title="Dependency hell">Dependency hell</a> for our recommendations.</p>
<h2 id="native-libraries">Native libraries<a class="doc-heading-anchor" href="#native-libraries"></a></h2>
<p>The repository runtime supports loading native libraries contained in the bundle. When you call <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#loadLibrary-java.lang.String-" title="System (Java Platform SE 8 )"><code>System.loadLibrary()</code></a>, the class loader for the bundle will automatically extract the contained native library if present in the bundle.</p>
<p>The library extraction mechanism is as follows:</p>
<ol class="doc-md-list">
<li>The dot (<code>'.'</code>) separators are converted to forward slashes (<code>'/'</code>).</li>
<li>The current <a href="../userguide/constraints.html#native-architecture" title="Native architecture">native architecture</a> environment value is appended to the library name separated using a dot (<code>'.'</code>).</li>
<li>The file name is mapped to an OS specific name using <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#mapLibraryName-java.lang.String-" title="System (Java Platform SE 8 )"><code>System.mapLibraryName()</code></a>.</li>
<li>If an entry exists in the bundle for the resulting path, it is extracted and loaded.</li>
<li>Else the runtime will map the library name without the appended native architecture and try loading it.</li>
<li>If the bundle entry still not found, the extraction fails.</li>
</ol>
<p>For example, the <code>path.to.MyLibrary</code> on Linux systems, on <code>amd64</code> architecture will be extracted the following way:</p>
<ol class="doc-md-list">
<li>If <code>path/to/libMyLibrary.amd64.so</code> is present, it is extracted.</li>
<li>Else if <code>path/to/libMyLibrary.so</code> is present, it is extracted.</li>
<li>In other cases the extraction fails.</li>
</ol>
<p>See the following Stack Overflow question for some information about <code>System.mapLibraryName()</code>: <a href="https://stackoverflow.com/questions/37203247" title="java - While loading JNI library, how the mapping happens with the actual library name - Stack Overflow">While loading JNI library, how the mapping happens with the actual library name</a></p>
<p><strong>Important</strong>: As seen in <a href="classpath.html#multiple-classloaders" title="Multiple ClassLoaders">Multiple ClassLoaders</a>, there may be scenarios when classes in a bundle is loaded multiple times. In these cases this may cause that a given native library needs to be loaded multiple times. However, a single native library <strong>cannot be loaded multiple times</strong> in a JVM process. Doing so will cause an <code>UnsatisfiedLinkError</code> to be thrown by the JVM when the library is attempted to be loaded the second time. See the dependency hell <a href="dependencyhell.html#native-libraries" title="Native libraries">Native libraries</a> section for mitigating this issue.</p>
<link href="../../../css/sakerscript.css"  rel="stylesheet" type="text/css" /></div>
			<div class="end-section-links">
				<div class="end-section-prev">
					<a class="doc-prev-section" href="../../doc/devguide/dependencies.html" title="Dependencies"><svg class="doc-section-arrow" viewBox="0 0 24 24">
    <path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
</svg>Dependencies</a>
				</div>
				<div class="end-section-next">
					<a class="doc-next-section" href="../../doc/devguide/dependencyhell.html" title="Dependency hell">Dependency hell<svg class="doc-section-arrow" viewBox="0 0 24 24">
    <path fill="currentColor" d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" />
</svg></a>
				</div>
			</div>
			<div class="doc-headings-nav">  <ul>    <li><a href="#bundle-classpath" title="Bundle classpath">Bundle classpath</a>      <ul>        <li><a href="#bundle-lifecycle" title="Bundle lifecycle">Bundle lifecycle</a>        </li>        <li><a href="#multiple-classloaders" title="Multiple ClassLoaders">Multiple ClassLoaders</a>        </li>        <li><a href="#native-libraries" title="Native libraries">Native libraries</a>        </li>      </ul>    </li>  </ul></div>
		</div>
	</div>
</div>
<div class="doc-footer">
	<div class="container">
		<div class="row">
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">About</p>
				<div><a href="/index.html" title="Saker.build home page">Home</a></div>
				<div data-footer-location="doc-docs"><a href="../../index.html" title="saker.nest documentation index">Documentation index</a></div>
				<div><a href="../../../saker.build/index.html" title="Information about the saker.build system">saker.build system</a></div>
				<div><a href="../../../saker.nest/index.html" title="Information about the saker.nest repository">saker.nest repository</a></div>
				<div><a href="/contact.html" title="Contact us">Contact</a></div>
			</div>
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">Resources</p>
				<div data-footer-location="doc-docs"><a href="../../doc/index.html" title="saker.nest documentation index">Documentation</a></div>
				<div data-footer-location="doc-javadoc"><a href="../../javadoc/index.html" title="JavaDoc for saker.nest">JavaDoc</a></div>
				<div data-footer-location="doc-taskdoc"><a href="../../taskdoc/index.html"  title="Documentation of build tasks in saker.nest">TaskDoc</a></div>
				<div data-footer-location="nest-package"><a href="https://nest.saker.build/package/saker.nest" title="saker.nest | saker.nest">saker.nest on saker.nest</a></div>
				<div><a href="https://github.com/sakerbuild/saker.nest" title="saker.nest on GitHub">GitHub</a></div>
			</div>
		</div>	
		<div class="row">
			<div class="col">
			&copy; Bence Sipka 2020
			</div>
		</div>
	</div>
</div>

<link rel="stylesheet" href="../../../res/hljs.css"><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js" integrity="sha256-js+I1fdbke/DJrW2qXQlrw7VUEqmdeFeOW37UC0bEiU=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/languages/plaintext.min.js"></script>
<script>
if(window.hasOwnProperty("hljs")){
	hljs.configure({
	  languages: []
	});
	hljs.initHighlightingOnLoad();
}
</script>

</body>
</html>