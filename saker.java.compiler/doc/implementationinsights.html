<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Implementation insights&nbsp;|&nbsp;saker.java.compiler</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
	
	<link rel="stylesheet" href="../../res/bootstrap.min.css" >
	<link rel="stylesheet" href="../../res/doc-saker.css" >

	<script type="application/ld+json">
	{
	  "@context": "https://schema.org",
	  "@type": "WebSite",
	  "name": "saker.java.compiler",
	  "url": "https://saker.build/saker.java.compiler"
	}
	</script>
</head>
<body data-nav-location="packagedoc" data-subdoc-presence="nest-package packagedoc javadoc taskdoc">
<div class="doc-nav-bar">
	<div class="container">
		<a class="home-link" href="../index.html" title="saker.java.compiler"><img style="height: 2.5em;" class="logo" src="../../res/logo.svg"/><span class="page-name">saker.java.compiler</span></a>
		<a class="nav-location-item" data-nav-location="doc-docs" href="../doc/index.html" title="Documentation">Documentation</a>
		<a class="nav-location-item" data-nav-location="doc-taskdoc" href="../taskdoc/index.html" title="Build task documentation">TaskDoc</a>
		<a class="nav-location-item" data-nav-location="doc-javadoc" href="../javadoc/index.html"title="Java API documentation">JavaDoc</a>
		<span class="nav-hover-packages-item"><span class="nav-hover-packages-span" onclick="return false;">Packages</span><div class="nav-hover-packages">
<ul>
<li><a href="/nest.repository.support/doc/index.html">nest.repository.support</a></li>
<li><a href="/saker.android/doc/index.html">saker.android</a></li>
<li><a href="/saker.apple/doc/index.html">saker.apple</a></li>
<li><a href="/saker.build/doc/index.html">saker.build</a></li>
<li><a href="/saker.clang/doc/index.html">saker.clang</a></li>
<li><a href="/saker.compiler.utils/doc/index.html">saker.compiler.utils</a></li>
<li><a href="/saker.jar/doc/index.html">saker.jar</a></li>
<li><a href="/saker.java.compiler/doc/index.html">saker.java.compiler</a></li>
<li><a href="/saker.java.testing/doc/index.html">saker.java.testing</a></li>
<li><a href="/saker.maven.classpath/doc/index.html">saker.maven.classpath</a></li>
<li><a href="/saker.maven.support/doc/index.html">saker.maven.support</a></li>
<li><a href="/saker.msvc/doc/index.html">saker.msvc</a></li>
<li><a href="/saker.nest/doc/index.html">saker.nest</a></li>
<li><a href="/saker.rmi/doc/index.html">saker.rmi</a></li>
<li><a href="/saker.sdk.support/doc/index.html">saker.sdk.support</a></li>
<li><a href="/saker.standard/doc/index.html">saker.standard</a></li>
<li><a href="/saker.util/doc/index.html">saker.util</a></li>
<li><a href="/saker.windows/doc/index.html">saker.windows</a></li>
<li><a href="/saker.zip/doc/index.html">saker.zip</a></li>
</ul>
</div></span>
		<div class="nav-bar-controls">
			<label class="d-xl-none nav-bar-collapse" for="collapse-nav-bar-label">
				<svg style="height: 1.5em;" viewBox="0 0 24 24">
				    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
				</svg>
			</label>
			<input style="display:none;" id="collapse-nav-bar-label" type="checkbox"/>
			<div class="nav-bar-items">
				<a href="/" title="saker.build home page">Home</a>
				<a href="/buildtrace.html" title="Build trace viewer">Build trace</a>
				<a style="display:none;" href="/sponsor.html" title="Sponsoring development">Sponsor</a>
				<a href="/blog/" title="saker.build system blog">Blog</a>
				<a class="no-external-icon" href="https://github.com/sakerbuild/saker.build" title="saker.build GitHub repository">GitHub</a>
			</div>
		</div>
	</div>
</div>
<div class="container page-contents packagedoc">
	<div class="row">
		<div class="col-12 col-lg-3 col-xl-2 p-lg-0">
			<div class="doc-navigation-container">
				<label class="d-lg-none nav-collapse" for="doc-collapse-nav-label">
					<svg style="height: 1.5em;" viewBox="0 0 24 24">
					    <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
					</svg>
					Navigation
				</label>
				<input style="display:none;" id="doc-collapse-nav-label" type="checkbox"/> 
				<div class="doc-nav">  <div class="doc-section"><ul><li><a class="doc-nav-section-link" href="../index.html" title="Index">Index</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Package details</p><ul><li><a class="doc-nav-section-link" href="index.html" title="Overview">Overview</a></li><li><a class="doc-nav-section-link" href="gettingstarted.html" title="Getting started">Getting started</a></li><li><a class="doc-nav-section-link" href="featurecomparison.html" title="Feature comparison">Feature comparison</a></li><li><a class="doc-nav-section-link" href="performancecomparison.html" title="Performance comparison">Performance comparison</a></li><li class="doc-active doc-active-parent"><a class="doc-nav-section-link" href="implementationinsights.html" title="Implementation insights">Implementation insights</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Java compilation</p><ul><li><a class="doc-nav-section-link" href="javacompile/index.html" title="Overview">Overview</a></li><li><a class="doc-nav-section-link" href="javacompile/basics.html" title="Basics">Basics</a></li><li><label class="doc-nav-collapse" for="_doc_collapse_id_0"><a class="doc-nav-section-link" href="javacompile/processors.html" title="Annotation processors">Annotation processors</a></label><input style="display:none;" id="_doc_collapse_id_0" type="checkbox"/><label class="doc-nav-section-arrow" for="_doc_collapse_id_0"></label><ul><li><a class="doc-nav-section-link" href="javacompile/processorconfig.html" title="Configuration">Configuration</a></li></ul></li><li><a class="doc-nav-section-link" href="javacompile/crosscompile.html" title="Cross-compilation">Cross-compilation</a></li><li><a class="doc-nav-section-link" href="javacompile/compileroptions.html" title="Compiler options">Compiler options</a></li><li><a class="doc-nav-section-link" href="javacompile/sdkmanagement.html" title="SDK management">SDK management</a></li><li><a class="doc-nav-section-link" href="javacompile/bundleclasspath.html" title="Bundle classpath">Bundle classpath</a></li></ul>  </div>  <div class="doc-section">    <p class="section-title">Examples</p><ul><li><a class="doc-nav-section-link" href="examples/index.html" title="Overview">Overview</a></li><li><a class="doc-nav-section-link" href="examples/simple.html" title="Simple compilation">Simple compilation</a></li><li><a class="doc-nav-section-link" href="examples/sourcefilter.html" title="Filter sources">Filter sources</a></li><li><a class="doc-nav-section-link" href="examples/classpath.html" title="Classpath">Classpath</a></li><li><a class="doc-nav-section-link" href="examples/processing.html" title="Annotation processing">Annotation processing</a></li><li><a class="doc-nav-section-link" href="examples/compilerparameters.html" title="Compiler parameters">Compiler parameters</a></li><li><a class="doc-nav-section-link" href="examples/parameternames.html" title="Reflection parameter names">Reflection parameter names</a></li><li><a class="doc-nav-section-link" href="examples/debuginfo.html" title="Debug information">Debug information</a></li><li><a class="doc-nav-section-link" href="examples/injectmoduleinfo.html" title="Injecting module-info attributes">Injecting module-info attributes</a></li><li><a class="doc-nav-section-link" href="examples/nativeheaders.html" title="Native headers">Native headers</a></li><li><a class="doc-nav-section-link" href="examples/jnicompile.html" title="JNI compilation">JNI compilation</a></li><li><a class="doc-nav-section-link" href="examples/addexports.html" title="Add module exports">Add module exports</a></li><li><a class="doc-nav-section-link" href="examples/crosscompile.html" title="Cross-compilation">Cross-compilation</a></li><li><a class="doc-nav-section-link" href="examples/nestbundleclasspath.html" title="Nest bundle classpath">Nest bundle classpath</a></li></ul>  </div></div>
			</div>
		</div>
		<div class="col-12 col-lg-9 col-xl-10 doc-page">
			<div class="doc-breadcrumb">
				<ol itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a itemscope itemtype="https://schema.org/WebPage" itemprop="item" href="../index.html" title="saker.java.compiler" itemid="/saker.java.compiler/index.html"><span itemprop="name">saker.java.compiler</span></a><meta itemprop="position" content="1" /></li> &rsaquo; <li><span title="Package details">Package details</span></li> &rsaquo; <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a itemscope itemtype="https://schema.org/WebPage" itemprop="item" href="implementationinsights.html" title="Implementation insights" itemid="/saker.java.compiler/doc/implementationinsights.html"><span itemprop="name">Implementation insights</span></a><meta itemprop="position" content="2" /></li></ol>
			</div>
			<div class="sb-sponsors" style="display: none;">
	<span class="sb-sponsors-title">Sponsors</span>
	<div class="container">
		<div class="row">
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
			<div class="col-md-4 col-12">
				<a class="sb-sponsors-link"></a>
			</div>
		</div>
	</div>
</div>
			<div class="doc-content"><h1 id="implementation-insights">Implementation insights<a class="doc-heading-anchor" href="#implementation-insights"></a></h1>
<p>In this document we provide some insights to the internal workings of the <a href="../taskdoc/saker.java.compile.html"><code>saker.java.compile()</code></a> task. This is mostly for the curious who are interested in the inner mechanisms of the incremental compilation handling.</p>
<p>In a nutshell, the task works the following way for clean builds:</p>
<ol class="doc-md-list">
<li>Determine the input source and class path files.</li>
<li>Parse the source files using the <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/" title="Compiler Tree API">Java Compiler API</a>.</li>
<li>If there are any annotation processors, instantiate them, and run the annotation processing manually.
<ul class="doc-md-list">
<li>The processing is run completely without <code>javac</code>.</li>
</ul>
</li>
<li>Ask <code>javac</code> to generate the bytecode class files based on the parsed source files.</li>
</ol>
<p>If incremental compilation is being done, additional operations are included in the above workflow:</p>
<ol class="doc-md-list">
<li>Determine the input source and class path files.</li>
<li>Check file changes, additions, and removals.
<ul class="doc-md-list">
<li>If any class path file changed (e.g. JAR file modified), then we (maybe) fall back to full recompilation.</li>
</ul>
</li>
<li>Parse the <em>changed</em> source files using the <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/" title="Compiler Tree API">Java Compiler API</a>.</li>
<li>Determine if there are any structural changes in the modified source files.
<ul class="doc-md-list">
<li>If yes, then determine how each change affects the other source files.</li>
<li>Add the affected files to the changed source file set, and go to 3.</li>
</ul>
</li>
<li>If there are any annotation processors, run annotation processing.
<ul class="doc-md-list">
<li>Any generated source files by the processors are parsed, and the changes are detected accordingly as previously.</li>
</ul>
</li>
<li>Ask <code>javac</code> to generate the bytecode class files based on the parsed source files.</li>
</ol>
<h2 id="communicating-with-javac">Communicating with <code>javac</code><a class="doc-heading-anchor" href="#communicating-with-javac"></a></h2>
<p>Thankfully the Java Compiler provides an API to invoke it programmatically. However, the API has some missing features, and we need to use private parts of the Java Compiler as well to implement our incremental compiler. We're not happy that it is necessary, but we aim to provide stability by testing the compatibility on each Java major release version.</p>
<p>When <code>javac</code> parses a source file, it returns a <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/CompilationUnitTree.html" title="CompilationUnitTree (Compiler Tree API )"><code>CompilationUnitTree</code></a> representation of it. These trees can be freely examined by us, and based on it we construct a complete representation of the classes in the parsed Java source files.</p>
<p>After parsing the class signatures, we determine if there were any changes compared to the signatures from the previous compilation. Any detected changes will cause other dependent source files to be parsed until there are no more changes detected.</p>
<p>After we run the annotation processing, we ask <code>javac</code> to generate the bytecode for the parsed source files. Any compilation errors will be reported by <code>javac</code> in this phase. After the bytecode is generated, we examine the parsed compilation unit trees once again to determine the depencies for each generated class. This is the phase that mainly differentiates our solution from <a href="featurecomparison.html#gradle-java-plugin" title="Gradle Java plugin">Gradle</a>, as we retrieve the dependency data directly from <code>javac</code>, rather than from the generated bytecode files. The difference lies in that the in-memory compilation unit trees contain more information about the source files than the generated class files. This allows us to work with finer dependency representations.</p>
<h2 id="annotation-processing">Annotation processing<a class="doc-heading-anchor" href="#annotation-processing"></a></h2>
<p>Incremental annotation processing was an unsolved problem until early 2018. It is not straight forward to implement this feature as processors are basically aribtrary plugins into the compilation process where they can do anything they like. Based on this, it is extremely hard to correctly determine the dependencies for an annotation processor, as there's very little opportunity for them to report the dependencies to the compiler.</p>
<p>However, (thankfully) the <a href="https://docs.oracle.com/javase/8/docs/api/javax/annotation/processing/Filer.html" title="Filer (Java Platform SE 8 )"><code>Filer</code></a> API for the annotation processors was constructed in a way that allows reporting dependencies for generated resources. As far as we know annotation processor implementations haven't really bother to pass the originating elements for generated resources, as nobody really used them. This made implementing incremental processing even more harder, as the annotation processors didn't even use the APIs correctly.</p>
<p>Our main goal for incremental annotation processing was the following:</p>
<ul class="doc-md-list">
<li>Support <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html#SOURCE" title="RetentionPolicy (Java Platform SE 8 )">source retention</a> annotations.
<ul class="doc-md-list">
<li>As we've previously mentioned in <a href="featurecomparison.html" title="Feature comparison">Feature comparison</a>, we believe that the tooling shouldn't impose restrictions on the codebase. If we didn't support annotations with source retention policy, then that would mean that annotations would needed to be part of the resulting class files even though it is not necessary for them to be present there.</li>
</ul>
</li>
<li>Support partial and minimal annotation processing.
<ul class="doc-md-list">
<li>If a processor doesn't generate resources based on some Java elements, then the changing of those elements shouldn't cause the processor to be reinvoked.</li>
<li>The processors shouldn't need information about the whole compilation set in order to produce their results, but only the ones they are interested about.</li>
</ul>
</li>
<li>Support arbitrary processor locations.
<ul class="doc-md-list">
<li>As a processor author, you may be fimilar with the <a href="https://docs.oracle.com/javase/8/docs/api/javax/tools/StandardLocation.html" title="StandardLocation (Java Platform SE 8 )"><code>StandardLocation</code></a> enumeration. In addition to those, we wanted to support arbitrary processor locations for input and output.</li>
</ul>
</li>
<li>Parallel annotation processing
<ul class="doc-md-list">
<li>The work of annotation processors can be cleanly separated. They should be run in a multi-threaded way so they can complete faster.</li>
</ul>
</li>
</ul>
<p>If you're reading this, you can probably guess that we succeeded with these goals. However, while implementing them we needed to put some restrictions on the annotation processors. The main one is that they must use the <code>Filer</code> API to access all the resources they need for their operations. They mustn't use the <a href="https://docs.oracle.com/javase/8/docs/api/java/io/File.html" title="File (Java Platform SE 8 )"><code>java.io.File</code></a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html" title="Files (Java Platform SE 8 )"><code>java.nio.file.Files</code></a> or related APIs.</p>
<p>In the end, we ended up implementing our own annotation processing mechanism that completely ignores the one that <code>javac</code> runs. This has quite a maintenance and implementational cost, but the benefits worth it.</p>
<p>An interesting note is that we support tracking changes in the JavaDoc of the Java elements. If a processor reads the documentation for a module, package, class, method, or field, and it is changed by the developer, then the processor will be reinvoked. Similarly, parameter name changes are also tracked when annotation processors are used. The processors are allowed to generate resources based on documentation contents, and they will work correctly. We found that this is an important use-case for example when generating help messages for a command line argument parser.</p>
<p>Also note that one thing that we don't <em>currently</em> support is the tracking of element positions in a class. If a developer simply reorders the methods or fields in a class, the processors won't be reinvoked. This will most likely be implemented in the future.</p>
<link href="../../css/sakerscript.css"  rel="stylesheet" type="text/css" /></div>
			<div class="end-section-links">
				<div class="end-section-prev">
					<a class="doc-prev-section" href="../doc/performancecomparison.html" title="Performance comparison"><svg class="doc-section-arrow" viewBox="0 0 24 24">
    <path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
</svg>Performance comparison</a>
				</div>
				<div class="end-section-next">
					<a class="doc-next-section" href="../doc/javacompile/index.html" title="Overview">Overview<svg class="doc-section-arrow" viewBox="0 0 24 24">
    <path fill="currentColor" d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" />
</svg></a>
				</div>
			</div>
			<div class="doc-headings-nav">  <ul>    <li><a href="#implementation-insights" title="Implementation insights">Implementation insights</a>      <ul>        <li><a href="#communicating-with-javac" title="Communicating with javac">Communicating with javac</a>        </li>        <li><a href="#annotation-processing" title="Annotation processing">Annotation processing</a>        </li>      </ul>    </li>  </ul></div>
		</div>
	</div>
</div>
<div class="doc-footer">
	<div class="container">
		<div class="row">
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">About</p>
				<div><a href="/index.html" title="Saker.build home page">Home</a></div>
				<div data-footer-location="doc-docs"><a href="../index.html" title="saker.java.compiler documentation index">Documentation index</a></div>
				<div><a href="../../saker.build/index.html" title="Information about the saker.build system">saker.build system</a></div>
				<div><a href="../../saker.nest/index.html" title="Information about the saker.nest repository">saker.nest repository</a></div>
				<div><a href="/contact.html" title="Contact us">Contact</a></div>
			</div>
			<div class="footer-section col-6 col-sm-4 col-md-3">
				<p class="footer-section-title">Resources</p>
				<div data-footer-location="doc-docs"><a href="../doc/index.html" title="saker.java.compiler documentation index">Documentation</a></div>
				<div data-footer-location="doc-javadoc"><a href="../javadoc/index.html" title="JavaDoc for saker.java.compiler">JavaDoc</a></div>
				<div data-footer-location="doc-taskdoc"><a href="../taskdoc/index.html"  title="Documentation of build tasks in saker.java.compiler">TaskDoc</a></div>
				<div data-footer-location="nest-package"><a href="https://nest.saker.build/package/saker.java.compiler" title="saker.java.compiler | saker.nest">saker.java.compiler on saker.nest</a></div>
				<div><a href="https://github.com/sakerbuild/saker.java.compiler" title="saker.java.compiler on GitHub">GitHub</a></div>
			</div>
		</div>	
		<div class="row">
			<div class="col site-copyright">
			&copy; Bence Sipka 2020
			</div>
		</div>
	</div>
</div>


<script>
if(window.hasOwnProperty("hljs")){
	hljs.configure({
	  languages: []
	});
	hljs.initHighlightingOnLoad();
}
</script>

</body>
</html>